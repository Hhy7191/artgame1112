<!DOCTYPE html>
<html lang='ko'>
<head>
    <meta charset='UTF-8'>
    <meta name='viewport' content='width=device-width, initial-scale=1.0'>
    <title>ë‚˜ë§Œì˜ ì•„íŠ¸ ìŠ¤íŠœë””ì˜¤</title>
    
    <!-- Tailwind CSS ë¡œë“œ -->
    <script src='https://cdn.tailwindcss.com'></script>
    <style>
        /* í°íŠ¸ ì„¤ì • */
        body { font-family: 'Inter', sans-serif; }
        
        /* ìº”ë²„ìŠ¤ ìŠ¤íƒ€ì¼: ë¶€ëª¨ ì»¨í…Œì´ë„ˆì— ë§ê²Œ ë°˜ì‘í˜•ìœ¼ë¡œ ì¡°ì • */
        #drawingCanvas {
            background-color: #ffffff;
            touch-action: none; /* í„°ì¹˜ ìŠ¤í¬ë¡¤ ë°©ì§€ */
            border: 1px solid #e5e7eb;
        }
        
        /* ì»¤ì„œ ìŠ¤íƒ€ì¼ ë³€ê²½ */
        .cursor-brush { cursor: crosshair; }
        .cursor-text { cursor: text; }
        .cursor-grab { cursor: grab !important; } /* í…ìŠ¤íŠ¸ ë°°ì¹˜ ëŒ€ê¸° ìƒíƒœ */

        /* í…œí”Œë¦¿ ì¸ë„¤ì¼ ìŠ¤íƒ€ì¼ */
        .template-thumbnail {
            width: 40px; 
            height: 40px;
            object-fit: cover;
            cursor: pointer;
            transition: transform 0.1s, box-shadow 0.1s;
            flex-shrink: 0; 
            border-radius: 6px;
            border: 2px solid transparent;
        }

        .template-thumbnail:hover {
            transform: scale(1.05);
        }

        .template-thumbnail.active {
            border-color: #3b82f6; /* Blue-500 */
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.5); 
        }
        
        /* ë©”ì‹œì§€ ë°•ìŠ¤ ì• ë‹ˆë©”ì´ì…˜ */
        #messageBox {
            opacity: 0;
            transition: opacity 0.3s, transform 0.3s;
            transform: translateY(10px) translateX(-50%); 
        }
        #messageBox.show {
            opacity: 1;
            transform: translateY(0) translateX(-50%);
        }
    </style>
    <!-- lucide icons ë¡œë“œ -->
    <script src="https://unpkg.com/lucide@latest"></script>
</head>
<body class='bg-gray-50 min-h-screen p-3 flex flex-col items-center'>

    <div id="messageBox" class="fixed top-5 left-1/2 bg-blue-500 text-white px-4 py-2 rounded-lg shadow-xl z-50"></div>

    <div class='w-full max-w-5xl bg-white rounded-xl shadow-2xl p-6 space-y-4'>
        <!-- íƒ€ì´í‹€ ë° ì„¤ëª… -->
        <header class='text-center'>
            <h1 class='text-3xl font-extrabold text-gray-800 flex items-center justify-center space-x-2'>
                <i data-lucide="palette" class="w-7 h-7 text-blue-600"></i>
                <span>ë‚˜ë§Œì˜ ì•„íŠ¸ ìŠ¤íŠœë””ì˜¤</span>
            </h1>
            <p class='text-gray-500 mt-1'>ë¡œë¥´ìƒ¤í ì´ë¯¸ì§€ ìœ„ì—ì„œ ë‹¹ì‹ ì˜ ìƒìƒë ¥ì„ í‘œí˜„í•´ë³´ì„¸ìš”.</p>
        </header>

        <!-- í…œí”Œë¦¿ ì„ íƒ ì˜ì—­ -->
        <div class="p-3 bg-gray-100 rounded-xl shadow-inner">
            <span class="text-sm font-semibold text-gray-700 block mb-2">ğŸ¨ ë°°ê²½ í…œí”Œë¦¿ ì„ íƒ (ë¡œë¥´ìƒ¤í ì´ë¯¸ì§€)</span>
            <div id="templateContainer" class="flex space-x-3 overflow-x-auto pb-1">
                <!-- í…œí”Œë¦¿ ì¸ë„¤ì¼ë“¤ì´ ì—¬ê¸°ì— ì‚½ì…ë©ë‹ˆë‹¤ -->
            </div>
        </div>

        <!-- ìº”ë²„ìŠ¤ ë° ë„êµ¬ ì˜ì—­ -->
        <div class='flex flex-col lg:flex-row space-y-4 lg:space-y-0 lg:space-x-4'>
            
            <!-- ë„êµ¬ íŒ¨ë„ (ì¢Œì¸¡) -->
            <div class='bg-gray-100 p-4 rounded-xl shadow-lg lg:w-48 flex flex-row lg:flex-col space-x-3 lg:space-x-0 lg:space-y-3 overflow-x-auto lg:overflow-visible flex-shrink-0'>
                
                <!-- 1. ë¶“/í…ìŠ¤íŠ¸ ë²„íŠ¼ ê·¸ë£¹ -->
                <div class="flex space-x-3 flex-shrink-0">
                    <button id="brushTool" class="tool-button w-10 h-10 bg-blue-500 hover:bg-blue-600 text-white font-semibold rounded-lg transition active" data-mode="brush" title="ë¶“ (ê·¸ë¦¬ê¸°)">
                        <i data-lucide="paintbrush" class="w-5 h-5 mx-auto"></i>
                    </button>
                    <button id="textTool" class="tool-button w-10 h-10 bg-gray-600 hover:bg-gray-700 text-white font-semibold rounded-lg transition" data-mode="text" title="í…ìŠ¤íŠ¸ ì…ë ¥">
                        <i data-lucide="type" class="w-5 h-5 mx-auto"></i>
                    </button>
                </div>
                
                <!-- 2. ìƒ‰ìƒ ì„ íƒê¸° (ì‚¬ìš©ì ìš”ì²­ì— ë”°ë¼ ë¶“/í…ìŠ¤íŠ¸ ë²„íŠ¼ ë°”ë¡œ ì•„ë˜ë¡œ ì´ë™) -->
                <div class="flex flex-col space-y-1 flex-shrink-0 w-full">
                    <label for="colorPicker" class="text-sm font-medium text-gray-700">ìƒ‰ìƒ ì„ íƒ</label>
                    <input type="color" id="colorPicker" value="#000000" class="w-full h-8 cursor-pointer rounded-md border-2 border-gray-300">
                </div>

                <!-- 3. í…ìŠ¤íŠ¸ ì…ë ¥ ê·¸ë£¹ -->
                <div id="textInputGroup" class="flex flex-col space-y-1 flex-shrink-0 w-full">
                    <label for="textInput" class="text-sm font-medium text-gray-700">í…ìŠ¤íŠ¸ ë‚´ìš©</label>
                    <input type="text" id="textInput" placeholder="ì…ë ¥ í›„ Enter í‚¤ë¥¼ ëˆ„ë¥´ì„¸ìš”" class="w-full p-2 rounded-md border border-gray-300 text-gray-800" value="Hello Gemini">
                    <p id="textHint" class="text-xs text-red-500 mt-1 hidden">**Enter í‚¤**ë¡œ í™•ì • í›„ ìº”ë²„ìŠ¤ í´ë¦­</p>
                </div>

                <!-- êµ¬ë¶„ì„  -->
                <div class="h-px w-full lg:h-px lg:w-full bg-gray-300 my-2 flex-shrink-0"></div>

                <!-- ë¶“ í¬ê¸° ìŠ¬ë¼ì´ë” -->
                <div class="flex flex-col space-y-1 flex-shrink-0">
                    <label for="sizeSlider" class="text-sm font-medium text-gray-700">í¬ê¸°: <span id="sizeValue">5</span>px</label>
                    <input type="range" id="sizeSlider" min="1" max="50" value="5" class="w-full h-2 rounded-lg appearance-none cursor-pointer bg-gray-300">
                </div>
            </div>

            <!-- ìº”ë²„ìŠ¤ ì˜ì—­ (ìš°ì¸¡/ì¤‘ì•™) -->
            <div class='flex-grow bg-gray-200 rounded-xl shadow-inner flex justify-center items-center p-2'>
                <canvas id="drawingCanvas" class='rounded-lg shadow-xl'></canvas>
            </div>
        </div>

        <!-- ì•¡ì…˜ ë²„íŠ¼ ì˜ì—­ -->
        <div class='flex flex-col sm:flex-row justify-center space-y-3 sm:space-y-0 sm:space-x-4 pt-4 border-t border-gray-200'>
            <!-- ì €ì¥ ë²„íŠ¼ -->
            <button id="saveButton" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-xl transition duration-150 shadow-md hover:shadow-lg">
                <i data-lucide="download" class="w-5 h-5 inline mr-2"></i> ê·¸ë¦¼ íŒŒì¼ë¡œ ë‹¤ìš´ë¡œë“œ & ê³µìœ 
            </button>
            <button onclick="undoLastAction()" class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-3 px-6 rounded-xl transition duration-150 shadow-md hover:shadow-lg">
                <i data-lucide="undo-2" class="w-5 h-5 inline mr-2"></i> ë˜ëŒë¦¬ê¸°
            </button>
            <button onclick="clearCanvas(false)" class="bg-red-500 hover:bg-red-600 text-white font-bold py-3 px-6 rounded-xl transition duration-150 shadow-md hover:shadow-lg">
                <i data-lucide="trash-2" class="w-5 h-5 inline mr-2"></i> ì „ì²´ ì§€ìš°ê¸°
            </button>
        </div>
        
        <!-- í”„ë¡¬í”„íŠ¸/ì˜ê° ì…ë ¥ ì¹¸ -->
        <div class='pt-4'>
            <h2 class='text-lg font-semibold text-gray-700 mb-2'>âœ¨ ë‚˜ë§Œì˜ ì˜ê° / í”„ë¡¬í”„íŠ¸ ì…ë ¥</h2>
            <textarea 
                id="promptInput" 
                placeholder="ì´ ê·¸ë¦¼ì— ëŒ€í•œ ë‹¹ì‹ ì˜ ìƒê°, í”„ë¡¬í”„íŠ¸, ë˜ëŠ” ì•„ì´ë””ì–´ë¥¼ ììœ ë¡­ê²Œ ê¸°ë¡í•´ ë³´ì„¸ìš”. (ë‹¤ìš´ë¡œë“œ & ê³µìœ  ì‹œ í•¨ê»˜ ì‚¬ìš©ë©ë‹ˆë‹¤.)" 
                class="w-full p-3 h-24 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 resize-none"
            ></textarea>
        </div>

    </div>

    <script type="module">
        lucide.createIcons();

        // Padlet URLì„ ì‚¬ìš©ìê°€ ìš”ì²­í•œ ì •í™•í•œ ì£¼ì†Œë¡œ ì„¤ì •
        const PADLET_URL = 'https://padlet.com/hy7191/padlet-vvey0i7aoep7kju6'; 
        
        // --- Canvas Setup ---
        const canvas = document.getElementById('drawingCanvas');
        const ctx = canvas.getContext('2d', { willReadFrequently: true });
        let currentWidth = 0;
        let currentHeight = 0;

        // --- State Variables ---
        let drawingMode = 'brush'; // 'brush', 'text'
        let currentColor = '#000000';
        let currentSize = 5;

        let isDrawing = false;
        let lastX = 0;
        let lastY = 0;
        
        // í…ìŠ¤íŠ¸ ë°°ì¹˜ ëŒ€ê¸° ìƒíƒœ
        let pendingTextToDraw = ''; 
        
        // Undo History (Canvas Data URLs)
        const history = [];
        const MAX_HISTORY = 20;
        
        // í˜„ì¬ ë¡œë“œëœ í…œí”Œë¦¿ì˜ URL
        let currentTemplateUrl = ''; 

        // --- Image Templates (ë¡œë¥´ìƒ¤í ì´ë¯¸ì§€) ---
        const templates = [
            { name: 'ë¡œë¥´ìƒ¤í 1', url: 'https://i.postimg.cc/kg20RfFr/1.png' }, 
            { name: 'ë¡œë¥´ìƒ¤í 2', url: 'https://i.postimg.cc/T3BZVgCY/2.png' }, 
            { name: 'ë¡œë¥´ìƒ¤í 3', url: 'https://i.postimg.cc/Jn3V40Ng/3.png' }, 
            { name: 'ë¡œë¥´ìƒ¤í 4', url: 'https://i.postimg.cc/rmGXFsGm/4.png' }, 
            { name: 'ë¡œë¥´ìƒ¤í 5', url: 'https://i.postimg.cc/nzKbcrKf/5.png' }, 
            { name: 'ë¡œë¥´ìƒ¤í 6', url: 'https://i.postimg.cc/ZRzzSpdM/6.png' }, 
            { name: 'ë¡œë¥´ìƒ¤í 7', url: 'https://i.postimg.cc/6q9s7KzL/7.png' }, 
            { name: 'ë¡œë¥´ìƒ¤í 8', url: 'https://i.postimg.cc/j2vpP1FY/8.png' }, 
            { name: 'ë¡œë¥´ìƒ¤í 9', url: 'https://i.postimg.cc/cLPVRwT2/9.png' }, 
            { name: 'ë¡œë¥´ìƒ¤í 10', url: 'https://i.postimg.cc/CxR3nmHT/10.png' }
        ];

        // --- Utility Functions ---

        /**
         * í˜„ì¬ ì¥ì¹˜ê°€ ëª¨ë°”ì¼ í™˜ê²½ì¸ì§€ í™•ì¸í•©ë‹ˆë‹¤.
         */
        function isMobileDevice() {
            return /Mobi|Android|iPhone|iPad|iPod|Windows Phone/i.test(navigator.userAgent);
        }

        /**
         * ìº”ë²„ìŠ¤ í¬ê¸°ë¥¼ ë¶€ëª¨ ì»¨í…Œì´ë„ˆì— ë§ê²Œ ì„¤ì •í•˜ê³  ë‚´ìš©ì„ ì¬ë¡œë“œí•©ë‹ˆë‹¤.
         */
        function resizeCanvas() {
            const container = canvas.parentElement;
            
            // 1. ì»¨í…Œì´ë„ˆ ë„ˆë¹„ ê¸°ë°˜ìœ¼ë¡œ ìµœëŒ€ ë„ˆë¹„ ê³„ì‚°
            currentWidth = container.clientWidth - 20; 
            
            // 2. 4:3 ë¹„ìœ¨ì„ ì„ í˜¸í•˜ëŠ” ë†’ì´ë¡œ ì„¤ì • 
            let preferredHeight = currentWidth * 0.75; 
            
            // 3. ë·°í¬íŠ¸ ë†’ì´ì˜ 65%ë¥¼ ìµœëŒ€ ë†’ì´ë¡œ ì„¤ì •
            const maxHeight = window.innerHeight * 0.65; 
            
            // 4. ë†’ì´ê°€ ìµœëŒ€ì¹˜ë¥¼ ì´ˆê³¼í•˜ë©´ ë†’ì´ì— ë§ì¶° ë„ˆë¹„ë¥¼ ì¬ê³„ì‚°
            if (preferredHeight > maxHeight) {
                currentHeight = maxHeight;
                // 4:3 ë¹„ìœ¨ ìœ ì§€ë¥¼ ìœ„í•´ ë„ˆë¹„ ì¬ê³„ì‚°
                currentWidth = currentHeight / 0.75;
            } else {
                currentHeight = preferredHeight;
            }

            // ì´ì „ ìº”ë²„ìŠ¤ ë‚´ìš©ì„ ì„ì‹œ ì €ì¥
            const lastState = history.length > 0 ? history[history.length - 1] : null;

            // 5. ìº”ë²„ìŠ¤ í¬ê¸° ì—…ë°ì´íŠ¸
            canvas.width = currentWidth;
            canvas.height = currentHeight;
            
            // 6. ë“œë¡œì‰ ì„¤ì •ì„ ë‹¤ì‹œ ì ìš©
            ctx.strokeStyle = currentColor;
            ctx.lineWidth = currentSize;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';

            // 7. ìº”ë²„ìŠ¤ ë‚´ìš© ì¬ë¡œë“œ (í™”ë©´ ë¹„ìœ¨ ë³€ê²½ ì‹œ ë‚´ìš© ìœ ì§€)
            if (lastState) {
                 const img = new Image();
                 img.onload = function() {
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    // ì´ì „ ë‚´ìš©ì„ ìƒˆ ìº”ë²„ìŠ¤ í¬ê¸°ì— ë§ê²Œ ê·¸ë¦½ë‹ˆë‹¤.
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                 };
                 img.src = lastState;
            } else {
                 // íˆìŠ¤í† ë¦¬ê°€ ì—†ìœ¼ë©´ í…œí”Œë¦¿ë§Œ ë‹¤ì‹œ ë¡œë“œ (ì´ˆê¸° ìƒíƒœ)
                 loadTemplate(currentTemplateUrl, false); 
            }
        }

        /**
         * ì¢Œí‘œë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤ (ë§ˆìš°ìŠ¤ ë˜ëŠ” í„°ì¹˜).
         */
        function getCoords(e) {
            const rect = canvas.getBoundingClientRect();
            let clientX, clientY;

            if (e.touches && e.touches.length > 0) {
                clientX = e.touches[0].clientX;
                clientY = e.touches[0].clientY;
                e.preventDefault(); // ìŠ¤í¬ë¡¤ ë°©ì§€
            } else {
                clientX = e.clientX;
                clientY = e.clientY;
            }
            
            // ìº”ë²„ìŠ¤ í•´ìƒë„ì— ë”°ë¥¸ ë…¼ë¦¬ì  í”½ì…€ ì¢Œí‘œë¥¼ ê³„ì‚°í•©ë‹ˆë‹¤.
            const x = (clientX - rect.left) * (canvas.width / rect.width);
            const y = (clientY - rect.top) * (canvas.height / rect.height); 

            return { x, y };
        }

        /**
         * ë©”ì‹œì§€ ë°•ìŠ¤ë¥¼ í‘œì‹œí•©ë‹ˆë‹¤.
         */
        function showMessage(message, duration = 6000) {
            const messageBox = document.getElementById('messageBox');
            messageBox.textContent = message;
            messageBox.classList.add('show');

            setTimeout(() => {
                messageBox.classList.remove('show');
            }, duration);
        }
        
        /**
         * í…ìŠ¤íŠ¸ë¥¼ í´ë¦½ë³´ë“œì— ë³µì‚¬í•©ë‹ˆë‹¤ (iframe í™˜ê²½ ëŒ€ì‘).
         */
        function copyTextToClipboard(text) {
            const textarea = document.createElement('textarea');
            textarea.value = text;
            textarea.style.position = 'fixed'; 
            textarea.style.left = '-9999px';
            textarea.style.top = '-9999px';
            document.body.appendChild(textarea);
            textarea.focus();
            textarea.select();
            try {
                const successful = document.execCommand('copy');
                return successful;
            } catch (err) {
                console.error('í´ë¦½ë³´ë“œ ë³µì‚¬ ì‹¤íŒ¨', err);
                return false;
            } finally {
                document.body.removeChild(textarea);
            }
        }


        // --- History Management ---

        /**
         * í˜„ì¬ ìº”ë²„ìŠ¤ ìƒíƒœë¥¼ íˆìŠ¤í† ë¦¬ì— ì €ì¥í•©ë‹ˆë‹¤.
         */
        function saveState() {
            if (history.length >= MAX_HISTORY) {
                history.shift(); 
            }
            history.push(canvas.toDataURL());
        }

        /**
         * ë§ˆì§€ë§‰ ë™ì‘ì„ ë˜ëŒë¦½ë‹ˆë‹¤.
         */
        function undoLastAction() {
            if (history.length > 1) {
                history.pop(); 
                const lastState = history[history.length - 1];
                
                const img = new Image();
                img.onload = function() {
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height); 
                    
                    updateTemplateActiveState(currentTemplateUrl); 
                    showMessage('ë˜ëŒë¦¬ê¸° ì™„ë£Œ!');
                };
                img.src = lastState;
            } else if (history.length === 1) {
                history.length = 0; 
                loadTemplate(currentTemplateUrl, true); 
                showMessage('ìº”ë²„ìŠ¤ê°€ ì´ˆê¸° ìƒíƒœë¡œ ëŒì•„ê°”ìŠµë‹ˆë‹¤!');
            } else {
                showMessage('ë” ì´ìƒ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            }
        }
        window.undoLastAction = undoLastAction; 

        // --- Template Functions ---
        
        // ì´ë¯¸ì§€ ë¡œë“œ ë° ì¤‘ì•™ 50% í¬ê¸°ë¡œ ê·¸ë¦¬ê¸°
        function loadAndDrawImage(url, scaleFactor = 0.5) {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = '#ffffff'; // ê¸°ë³¸ í°ìƒ‰ ë°°ê²½
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            if (!url) {
                saveState();
                return;
            }

            const img = new Image();
            img.crossOrigin = 'Anonymous'; 

            img.onload = function() {
                const imgWidth = img.naturalWidth;
                const imgHeight = img.naturalHeight;

                const canvasAspectRatio = canvas.width / canvas.height;
                const imageAspectRatio = imgWidth / imgHeight;

                let dWidth, dHeight; 
                
                // ìº”ë²„ìŠ¤ í¬ê¸°ì— ë§ê²Œ ì´ë¯¸ì§€ í¬ê¸° ì¡°ì •
                if (imageAspectRatio > canvasAspectRatio) { 
                    dHeight = canvas.height;
                    dWidth = canvas.height * imageAspectRatio;
                } else {
                    dWidth = canvas.width;
                    dHeight = canvas.width / imageAspectRatio;
                }
                
                // 50% ë¹„ìœ¨ë¡œ ì¶•ì†Œ
                const scaledWidth = dWidth * scaleFactor;
                const scaledHeight = dHeight * scaleFactor;
                
                // ì¤‘ì•™ ì •ë ¬ì„ ìœ„í•œ ì¢Œí‘œ ê³„ì‚°
                const finalDx = (canvas.width - scaledWidth) / 2;
                const finalDy = (canvas.height - scaledHeight) / 2;

                ctx.drawImage(img, finalDx, finalDy, scaledWidth, scaledHeight);
                saveState();
                showMessage('ë¡œë¥´ìƒ¤í í…œí”Œë¦¿ì´ ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.');
            };

            img.onerror = function() {
                ctx.fillStyle = '#ffffff';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                saveState();
                showMessage('í…œí”Œë¦¿ ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. í°ìƒ‰ ë°°ê²½ìœ¼ë¡œ ì´ˆê¸°í™”í•©ë‹ˆë‹¤.');
            };
            
            img.src = url;
        }

        function loadTemplate(url, shouldSaveState = true) {
            currentTemplateUrl = url;
            loadAndDrawImage(url);
            updateTemplateActiveState(url);
        }

        function clearCanvas(shouldConfirm = true) {
            
            // history ì´ˆê¸°í™”
            history.length = 0;
            
            // í˜„ì¬ í…œí”Œë¦¿ë§Œ ë‹¤ì‹œ ë¡œë“œí•˜ì—¬ ë“œë¡œì‰ ë‚´ìš©ë§Œ ì§€ì›ë‹ˆë‹¤.
            loadTemplate(currentTemplateUrl, true);
            document.getElementById('brushTool').click();
            showMessage('ìº”ë²„ìŠ¤ ìœ„ì˜ ê·¸ë¦¼ì„ ì´ˆê¸°í™”í–ˆìŠµë‹ˆë‹¤.');
        }
        window.clearCanvas = clearCanvas;

        function updateTemplateActiveState(url) {
             document.querySelectorAll('.template-thumbnail').forEach(el => {
                el.classList.remove('active');
                if (el.dataset.url === url) {
                    el.classList.add('active');
                }
             });
        }

        function initTemplates() {
            const container = document.getElementById('templateContainer');
            
            templates.forEach((template, index) => {
                const img = document.createElement('img');
                img.src = template.url; 
                img.alt = template.name;
                img.title = template.name;
                img.className = 'template-thumbnail rounded-md';
                img.dataset.url = template.url;

                img.addEventListener('click', () => {
                    loadTemplate(img.dataset.url);
                });

                container.appendChild(img);
                
                if (index === 0) {
                    img.classList.add('active');
                }
            });
            
            resizeCanvas();
            // history ì´ˆê¸°í™” í›„ ì²« í…œí”Œë¦¿ ë¡œë“œ (ë¡œë¥´ìƒ¤í 1)
            history.length = 0;
            loadTemplate(templates[0].url); 
        }

        // --- Color Picker Function ---
        const colorPicker = document.getElementById('colorPicker');

        function selectColor(color) {
            currentColor = color;
            colorPicker.value = color; 
            showMessage(`ìƒ‰ìƒì„ ${currentColor}ë¡œ ë³€ê²½í–ˆìŠµë‹ˆë‹¤.`);
        }
        
        // --- Drawing Functions (Brush) ---

        function startDrawing(e) {
            e.preventDefault();
            isDrawing = true;
            const { x, y } = getCoords(e);
            [lastX, lastY] = [x, y];
        }

        function draw(e) {
            e.preventDefault(); 
            if (!isDrawing || drawingMode !== 'brush') return;

            const { x, y } = getCoords(e);

            ctx.beginPath();
            ctx.moveTo(lastX, lastY);
            ctx.lineTo(x, y);
            ctx.strokeStyle = currentColor;
            ctx.lineWidth = currentSize;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            ctx.stroke();

            [lastX, lastY] = [x, y];
        }

        function stopDrawing(e) {
            if (isDrawing) {
                isDrawing = false;
                saveState(); 
            }
        }
        
        // --- Drawing Functions (Text) ---

        const textInput = document.getElementById('textInput');
        const textHint = document.getElementById('textHint');

        // í…ìŠ¤íŠ¸ ì…ë ¥ í•„ë“œì— Enter í‚¤ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€ (Enterë¡œ í™•ì •)
        textInput.addEventListener('keydown', (e) => {
            if (drawingMode === 'text' && e.key === 'Enter') {
                e.preventDefault();
                const textToSubmit = textInput.value.trim();
                
                if (textToSubmit) {
                    pendingTextToDraw = textToSubmit;
                    textInput.value = ''; // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
                    // ë°°ì¹˜ ì¤€ë¹„ ìƒíƒœ ì‹œê°í™”
                    canvas.classList.remove('cursor-text');
                    canvas.classList.add('cursor-grab'); 
                    showMessage('âœ… í…ìŠ¤íŠ¸ê°€ í™•ì •ë˜ì—ˆìŠµë‹ˆë‹¤. ìº”ë²„ìŠ¤ë¥¼ í´ë¦­í•˜ì—¬ ë°°ì¹˜í•˜ì„¸ìš”.');
                } else {
                    showMessage('ë°°ì¹˜í•  í…ìŠ¤íŠ¸ë¥¼ ë¨¼ì € ì…ë ¥í•´ì£¼ì„¸ìš”.', 2000);
                }
            }
        });

        // í…ìŠ¤íŠ¸ ëª¨ë“œì—ì„œ ìº”ë²„ìŠ¤ í´ë¦­ ì‹œ í…ìŠ¤íŠ¸ ê·¸ë¦¬ê¸°
        function handleTextPlacement(e) {
            if (drawingMode !== 'text' || !pendingTextToDraw) {
                if (drawingMode === 'text') {
                     showMessage("í…ìŠ¤íŠ¸ ì…ë ¥ í›„ Enter í‚¤ë¥¼ ëˆŒëŸ¬ í™•ì •í•´ì•¼ í•©ë‹ˆë‹¤.", 2000);
                }
                return; 
            }

            const textToDraw = pendingTextToDraw;
            const { x, y } = getCoords(e);

            ctx.fillStyle = currentColor;
            ctx.font = `${currentSize * 2}px Inter, sans-serif`; 
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            
            // ìº”ë²„ìŠ¤ì— í…ìŠ¤íŠ¸ ê·¸ë¦¬ê¸°
            ctx.fillText(textToDraw, x, y);
            
            // ìƒíƒœ ì´ˆê¸°í™”
            pendingTextToDraw = '';
            canvas.classList.remove('cursor-grab');
            canvas.classList.add('cursor-text');
            saveState();
            
            showMessage(`í…ìŠ¤íŠ¸ë¥¼ [${textToDraw.substring(0, 10)}] ìœ„ì¹˜ì— ë°°ì¹˜í–ˆìŠµë‹ˆë‹¤.`);
        }
        
        // --- Save and Share Logic (í”„ë¡¬í”„íŠ¸ í…ìŠ¤íŠ¸ í¬í•¨) ---

        /**
         * í˜„ì¬ ìº”ë²„ìŠ¤ ë‚´ìš©ê³¼ í”„ë¡¬í”„íŠ¸ í…ìŠ¤íŠ¸ë¥¼ í¬í•¨í•˜ëŠ” ì„ì‹œ ìº”ë²„ìŠ¤ë¥¼ ìƒì„±í•˜ê³  Data URLì„ ë°˜í™˜í•©ë‹ˆë‹¤.
         */
        function getCanvasWithPrompt() {
            const promptText = document.getElementById('promptInput').value.trim();
            const tempCanvas = document.createElement('canvas');
            const tempCtx = tempCanvas.getContext('2d');
            
            // 1. í¬ê¸° ì„¤ì •: ì›ë³¸ ìº”ë²„ìŠ¤ì™€ ë™ì¼
            tempCanvas.width = canvas.width;
            tempCanvas.height = canvas.height;

            // 2. í˜„ì¬ ìº”ë²„ìŠ¤ ë‚´ìš© ë³µì‚¬
            tempCtx.drawImage(canvas, 0, 0);

            if (promptText) {
                // 3. í…ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼ ë° ìœ„ì¹˜ ì„¤ì •
                const maxTextWidth = tempCanvas.width * 0.9;
                const lineHeight = 30; 
                
                // í…ìŠ¤íŠ¸ ìƒ‰ìƒ
                tempCtx.fillStyle = '#000000';
                tempCtx.textAlign = 'center';
                
                // í…ìŠ¤íŠ¸ ì¤„ë°”ê¿ˆ ì²˜ë¦¬
                let words = promptText.split(' ');
                let line = '';
                let lines = [];
                
                for(let n = 0; n < words.length; n++) {
                    let testLine = line + words[n] + ' ';
                    tempCtx.font = '16px Inter, sans-serif'; // ë³¸ë¬¸ í°íŠ¸
                    let metrics = tempCtx.measureText(testLine);
                    let testWidth = metrics.width;
                    
                    if (testWidth > maxTextWidth && n > 0) {
                        lines.push(line.trim());
                        line = words[n] + ' ';
                    } else {
                        line = testLine;
                    }
                }
                lines.push(line.trim());

                // í…ìŠ¤íŠ¸ê°€ ê¸¸ ê²½ìš° ìµœëŒ€ 3ì¤„ê¹Œì§€ë§Œ í‘œì‹œ
                const maxLinesToShow = 3;
                if (lines.length > maxLinesToShow) {
                    lines = lines.slice(0, maxLinesToShow);
                    lines[maxLinesToShow - 1] += '...';
                }
                
                // ì´ í…ìŠ¤íŠ¸ ë†’ì´ ê³„ì‚°
                const totalTextHeight = lines.length * lineHeight;
                
                // ì‹œì‘ Y ìœ„ì¹˜ ì„¤ì • (í•˜ë‹¨ 20px ë§ˆì§„)
                let y = tempCanvas.height - 20 - totalTextHeight; 
                
                // ì œëª© ì¶”ê°€
                tempCtx.font = 'bold 18px Inter, sans-serif'; 
                tempCtx.fillText('âœ¨ ë‚˜ì˜ ì˜ê°:', tempCanvas.width / 2, y);
                y += 5; // ì œëª©ê³¼ ë³¸ë¬¸ ì‚¬ì´ ê°„ê²©

                // ë³¸ë¬¸ í…ìŠ¤íŠ¸ ê·¸ë¦¬ê¸°
                tempCtx.font = '16px Inter, sans-serif'; 
                lines.forEach((l, index) => {
                    tempCtx.fillText(l, tempCanvas.width / 2, y + lineHeight + (index * lineHeight));
                });
            }

            return tempCanvas.toDataURL('image/png');
        }

        document.getElementById('saveButton').addEventListener('click', () => {
            const promptText = document.getElementById('promptInput').value.trim();
            const imageURL = getCanvasWithPrompt(); 
            
            let downloadMessage = '';

            if (isMobileDevice()) {
                // --- 1. ëª¨ë°”ì¼ í™˜ê²½: ìƒˆ íƒ­ ì—´ê¸° (ê¸¸ê²Œ ëˆŒëŸ¬ ì €ì¥ ìœ ë„) ---
                window.open(imageURL, '_blank'); 
                downloadMessage = 'ğŸ–¼ï¸ 1ë‹¨ê³„: ì™„ì„±ëœ ê·¸ë¦¼ì´ ìƒˆ íƒ­ì— ì—´ë ¸ìŠµë‹ˆë‹¤. íœ´ëŒ€í°ì—ì„œëŠ” ì´ë¯¸ì§€ë¥¼ **ê¸¸ê²Œ ëˆŒëŸ¬** ê°¤ëŸ¬ë¦¬ì— ì €ì¥í•˜ì„¸ìš”.';

            } else {
                // --- 2. PC í™˜ê²½: download ì†ì„±ì„ ì‚¬ìš©í•œ ì§ì ‘ ë‹¤ìš´ë¡œë“œ ---
                const a = document.createElement('a');
                a.href = imageURL;
                a.download = `ë‚˜ë§Œì˜-ì•„íŠ¸-${Date.now()}.png`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                downloadMessage = 'ğŸ–¼ï¸ 1ë‹¨ê³„: ê·¸ë¦¼ íŒŒì¼ì´ ìë™ìœ¼ë¡œ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ìš´ë¡œë“œ í´ë”ë¥¼ í™•ì¸í•˜ì„¸ìš”.';
            }

            // 3. í”„ë¡¬í”„íŠ¸ í´ë¦½ë³´ë“œ ë³µì‚¬ 
            let shareMessage = '';
            if (promptText) {
                const success = copyTextToClipboard(promptText);
                if (success) {
                    shareMessage = 'âœ… 2ë‹¨ê³„: ê·¸ë¦¼ ì„¤ëª…(í”„ë¡¬í”„íŠ¸)ì´ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.';
                } else {
                    shareMessage = 'âš ï¸ 2ë‹¨ê³„: í´ë¦½ë³´ë“œ ë³µì‚¬ ì‹¤íŒ¨. ê·¸ë¦¼ ì„¤ëª…ì„ ìˆ˜ë™ìœ¼ë¡œ ë³µì‚¬í•´ì£¼ì„¸ìš”.';
                }
            } else {
                shareMessage = 'âš ï¸ 2ë‹¨ê³„: ê·¸ë¦¼ ì„¤ëª…(í”„ë¡¬í”„íŠ¸)ì€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.';
            }

            // 4. Padlet URL ì—´ê¸°
            window.open(PADLET_URL, '_blank');
            
            // 5. ì¢…í•© ë©”ì‹œì§€ ì•ˆë‚´
            showMessage(`${downloadMessage} ${shareMessage} 3ë‹¨ê³„: Padlet í˜ì´ì§€ê°€ ìƒˆ íƒ­ì— ì—´ë ¸ìŠµë‹ˆë‹¤. ì €ì¥í•œ ê·¸ë¦¼ê³¼ ë³µì‚¬í•œ ì„¤ëª…ì„ ë¶™ì—¬ë„£ì–´ ê³µìœ í•˜ì„¸ìš”!`, 10000); 
        });
        
        // --- Event Listeners (Setup & UI) ---

        // UI ëª¨ë“œ ë³€ê²½
        document.querySelectorAll('.tool-button').forEach(button => {
            button.addEventListener('click', () => {
                document.querySelectorAll('.tool-button').forEach(btn => {
                    btn.classList.remove('active', 'bg-blue-500', 'hover:bg-blue-600');
                    btn.classList.add('bg-gray-600', 'hover:bg-gray-700');
                });
                
                button.classList.add('active', 'bg-blue-500', 'hover:bg-blue-600');
                button.classList.remove('bg-gray-600', 'hover:bg-gray-700');
                
                drawingMode = button.dataset.mode;
                
                // í…ìŠ¤íŠ¸ ë°°ì¹˜ ëŒ€ê¸° ìƒíƒœ ë° ì»¤ì„œ ì´ˆê¸°í™”
                pendingTextToDraw = '';
                canvas.classList.remove('cursor-grab', 'cursor-text', 'cursor-brush');
                
                // í…ìŠ¤íŠ¸ íŒíŠ¸ í‘œì‹œ ë¡œì§ë§Œ ìˆ˜ì •
                if (drawingMode === 'text') {
                    textHint.classList.remove('hidden'); // íŒíŠ¸ í‘œì‹œ
                    canvas.classList.add('cursor-text');
                    showMessage('í…ìŠ¤íŠ¸ ëª¨ë“œ. ì…ë ¥ í›„ Enterë¥¼ ëˆŒëŸ¬ í™•ì •í•˜ì„¸ìš”.');
                } else {
                    textHint.classList.add('hidden'); // íŒíŠ¸ ìˆ¨ê¹€
                    canvas.classList.add('cursor-brush');
                    showMessage('ë¶“ ëª¨ë“œ. ììœ ë¡­ê²Œ ê·¸ë¦¼ì„ ê·¸ë¦¬ì„¸ìš”.');
                }
            });
        });

        // ìƒ‰ìƒ ë³€ê²½
        colorPicker.addEventListener('input', (e) => {
            selectColor(e.target.value);
        });

        // í¬ê¸° ë³€ê²½
        const sizeSlider = document.getElementById('sizeSlider');
        const sizeValueSpan = document.getElementById('sizeValue');
        sizeSlider.addEventListener('input', (e) => {
            currentSize = parseInt(e.target.value);
            sizeValueSpan.textContent = currentSize;
        });

        window.addEventListener('load', () => {
            initTemplates();
            // ê¸°ë³¸ ì»¤ì„œ ì„¤ì •
            canvas.classList.add('cursor-brush');
        });
        
        window.addEventListener('resize', resizeCanvas);


        // --- Canvas Event Listeners (Unified) ---
        
        // Mouse Events
        canvas.addEventListener('mousedown', (e) => {
            if (drawingMode === 'brush') startDrawing(e);
        });
        canvas.addEventListener('mousemove', draw);
        canvas.addEventListener('mouseup', (e) => { 
            if (drawingMode === 'brush') stopDrawing(e);
        }); 
        canvas.addEventListener('mouseout', (e) => { 
            if (drawingMode === 'brush') stopDrawing(e);
        }); 
        
        // í…ìŠ¤íŠ¸ ëª¨ë“œì—ì„œëŠ” í´ë¦­ ì‹œ í…ìŠ¤íŠ¸ ë°°ì¹˜
        canvas.addEventListener('click', (e) => {
            if (drawingMode === 'text') handleTextPlacement(e);
        });

        // Touch Events
        canvas.addEventListener('touchstart', (e) => {
            if (drawingMode === 'brush') startDrawing(e);
        });
        canvas.addEventListener('touchmove', draw);
        canvas.addEventListener('touchend', (e) => { 
            if (drawingMode === 'brush') stopDrawing(e);
        }); 
        canvas.addEventListener('touchcancel', (e) => { 
            if (drawingMode === 'brush') stopDrawing(e);
        }); 
        
    </script>
</body>
</html>